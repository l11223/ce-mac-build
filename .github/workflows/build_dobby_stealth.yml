name: Build Cheat Engine Mac (Stealth)

on:
  workflow_dispatch:
    inputs:
      stealth_mode:
        description: 'Enable stealth mode'
        required: false
        default: 'true'
        type: boolean
      version_suffix:
        description: 'Version suffix (e.g., stealth, beta)'
        required: false
        default: 'stealth'
        type: string
  push:
    paths:
      - 'cheat-engine-master/**'
      - 'ce_mac_patches/**'
      - '.github/workflows/build_ce_mac.yml'
  pull_request:
    paths:
      - 'cheat-engine-master/**'
      - 'ce_mac_patches/**'

env:
  CE_VERSION: "7.5.2"
  LAZARUS_VERSION: "2.2.4"

jobs:
  build-mac-ce:
    runs-on: macos-latest
    timeout-minutes: 120
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Setup macOS dependencies
      run: |
        # Install Homebrew if not exists
        if ! command -v brew &> /dev/null; then
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        fi
        
        # Update Homebrew
        brew update
        
        # Install required dependencies
        brew install --cask lazarus
        brew install fpc
        brew install git
        brew install cmake
        brew install ninja
        
    - name: Verify Lazarus installation
      run: |
        echo "Lazarus version:"
        lazbuild --version
        echo "FPC version:"
        fpc -iV
        
        # Check Lazarus directories
        echo "Lazarus installation directories:"
        find /usr/local -name "*lazarus*" -type d 2>/dev/null || true
        find /opt -name "*lazarus*" -type d 2>/dev/null || true
        
    - name: Create missing macport files
      run: |
        mkdir -p ce_mac_patches
        
        # Create basic macport.pas stub
        cat > ce_mac_patches/macport.pas << 'EOF'
        unit macport;
        
        {$mode objfpc}{$H+}
        
        interface
        
        uses
          Classes, SysUtils, ctypes, Unix, BaseUnix;
        
        // Basic macOS compatibility functions
        function OpenProcess(dwDesiredAccess: DWORD; bInheritHandle: BOOL; dwProcessId: DWORD): THandle; cdecl;
        function getCPUCount: integer;
        function GetThreadContextArm64(hThread: THandle; var lpContext: pointer): BOOL; cdecl;
        function SetThreadContextArm64(hThread: THandle; var lpContext: pointer): BOOL; cdecl;
        procedure macPortFixRegPath;
        
        implementation
        
        function OpenProcess(dwDesiredAccess: DWORD; bInheritHandle: BOOL; dwProcessId: DWORD): THandle; cdecl;
        begin
          // Basic implementation for macOS
          Result := fpOpen('/proc/' + IntToStr(dwProcessId), O_RDONLY);
        end;
        
        function getCPUCount: integer;
        begin
          Result := 8; // Default value, should be dynamic
        end;
        
        function GetThreadContextArm64(hThread: THandle; var lpContext: pointer): BOOL; cdecl;
        begin
          Result := False; // Not implemented yet
        end;
        
        function SetThreadContextArm64(hThread: THandle; var lpContext: pointer): BOOL; cdecl;
        begin
          Result := False; // Not implemented yet
        end;
        
        procedure macPortFixRegPath;
        begin
          // Fix registry path for macOS
        end;
        
        end.
        EOF
        
        # Create macportdefines.pas
        cat > ce_mac_patches/macportdefines.pas << 'EOF'
        unit macportdefines;
        
        {$mode objfpc}{$H+}
        
        interface
        
        // macOS-specific defines
        const
          PROCESS_ALL_ACCESS = $FFFFFFFF;
          
        type
          // Basic types for macOS compatibility
          THandle = TLibHandle;
          DWORD = cuint32;
          BOOL = LongBool;
          LPVOID = Pointer;
          
        implementation
        
        end.
        EOF
        
        echo "Created basic macport files"
        
    - name: Copy macport files to CE source
      run: |
        # Copy macport files to the correct location
        cp ce_mac_patches/macport.pas "cheat-engine-master/cheat-engine-master/Cheat Engine/"
        cp ce_mac_patches/macportdefines.pas "cheat-engine-master/cheat-engine-master/Cheat Engine/"
        
        echo "Copied macport files to CE source directory"
        
    - name: Apply stealth patches
      if: github.event.inputs.stealth_mode == 'true' || github.event_name != 'workflow_dispatch'
      run: |
        mkdir -p ce_mac_patches/stealth
        
        # Create stealth patch for CE strings
        cat > ce_mac_patches/stealth/0001-hide_ce_strings.patch << 'EOF'
        --- a/cheat-engine-master/Cheat Engine/MainUnit.pas
        +++ b/cheat-engine-master/Cheat Engine/MainUnit.pas
        @@ -290,7 +290,7 @@
           Application.Title:='Cheat Engine 7.5';
         -  //'Cheat Engine 7.3';
         +  //'Memory Editor 7.5';
         EOF
        
        # Apply patches if they exist
        if [ -f "ce_mac_patches/stealth/0001-hide_ce_strings.patch" ]; then
          cd cheat-engine-master
          git apply ce_mac_patches/stealth/0001-hide_ce_strings.patch || echo "Patch failed, continuing..."
          cd ..
        fi
        
        echo "Applied stealth patches"
        
    - name: Configure Lazarus environment
      run: |
        # Set up Lazarus environment variables
        echo "LAZARUS_DIR=/usr/local/share/lazarus" >> $GITHUB_ENV
        echo "FPC_DIR=/usr/local/lib/fpc" >> $GITHUB_ENV
        
        # Find Lazarus configuration
        if [ -d "$HOME/Library/Application Support/Lazarus" ]; then
          echo "LAZARUS_CONFIG=$HOME/Library/Application Support/Lazarus" >> $GITHUB_ENV
        elif [ -d "/usr/local/share/lazarus" ]; then
          echo "LAZARUS_CONFIG=/usr/local/share/lazarus" >> $GITHUB_ENV
        fi
        
        echo "Lazarus environment configured"
        
    - name: Build Cheat Engine (Mac)
      run: |
        cd "cheat-engine-master/cheat-engine-master/Cheat Engine"
        
        # Try different Lazarus build approaches
        echo "Attempting to build with lazbuild..."
        
        # Method 1: Direct lazbuild
        if command -v lazbuild &> /dev/null; then
          echo "Using lazbuild..."
          lazbuild --build-mode=release cheatengine.lpi || echo "lazbuild failed"
        fi
        
        # Method 2: Makefile approach
        echo "Attempting makefile build..."
        if [ -f "Makefile" ]; then
          make || echo "make failed"
        fi
        
        # Method 3: Direct FPC compilation
        echo "Attempting direct FPC compilation..."
        if [ -f "cheatengine.lpr" ]; then
          fpc -B -O2 -gl cheatengine.lpr || echo "FPC compilation failed"
        fi
        
        echo "Build attempts completed"
        
    - name: Post-build processing
      run: |
        cd "cheat-engine-master/cheat-engine-master/Cheat Engine"
        
        # Check if binary was created
        if [ -f "cheatengine" ]; then
          echo "✅ Cheat Engine binary found"
          ls -la cheatengine
          
          # Apply basic stealth modifications
          if [ "${{ github.event.inputs.stealth_mode }}" == "true" ] || [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            echo "Applying stealth modifications..."
            
            # Strip debug symbols
            strip cheatengine || echo "strip failed"
            
            # Modify binary strings (basic approach)
            sed -i '' 's/Cheat Engine/Memory Editor/g' cheatengine || echo "string replacement failed"
            sed -i '' 's/cheatengine/memoryeditor/g' cheatengine || echo "filename replacement failed"
          fi
          
          # Create DMG package
          mkdir -p ../release
          cp cheatengine ../release/
          
          # Create simple app bundle
          mkdir -p ../release/Cheat\ Engine.app/Contents/MacOS
          mkdir -p ../release/Cheat\ Engine.app/Contents/Resources
          
          # Create Info.plist
          cat > ../release/Cheat\ Engine.app/Contents/Info.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>cheatengine</string>
            <key>CFBundleIdentifier</key>
            <string>com.cheatengine.ce</string>
            <key>CFBundleName</key>
            <string>Memory Editor</string>
            <key>CFBundleVersion</key>
            <string>${{ env.CE_VERSION }}</string>
            <key>CFBundleShortVersionString</key>
            <string>${{ env.CE_VERSION }}</string>
            <key>NSHighResolutionCapable</key>
            <true/>
        </dict>
        </plist>
        EOF
          
          cp cheatengine "../release/Cheat Engine.app/Contents/MacOS/"
          
          echo "✅ App bundle created"
        else
          echo "❌ Cheat Engine binary not found"
          echo "Directory contents:"
          ls -la
        fi
        
    - name: Create release package
      run: |
        cd cheat-engine-master
        mkdir -p release
        
        if [ -f "release/Cheat Engine.app/Contents/MacOS/cheatengine" ]; then
          # Create DMG
          hdiutil create -volname "Cheat Engine ${{ env.CE_VERSION }}" -srcfolder release -ov -format UDZO "CheatEngine-${{ env.CE_VERSION }}-${{ github.event.inputs.version_suffix || 'stealth' }}.dmg"
          
          echo "✅ DMG package created"
          ls -la *.dmg
        else
          echo "❌ No app bundle found to package"
        fi
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: cheat-engine-mac-${{ github.event.inputs.version_suffix || 'stealth' }}
        path: |
          cheat-engine-master/*.dmg
          cheat-engine-master/release/
        retention-days: 30
        
    - name: Build summary
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ env.CE_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Stealth Mode**: ${{ github.event.inputs.stealth_mode || 'true' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Lazarus Version**: ${{ env.LAZARUS_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "cheat-engine-master/release/Cheat Engine.app/Contents/MacOS/cheatengine" ]; then
          echo "✅ **Status**: Success" >> $GITHUB_STEP_SUMMARY
          echo "- **Binary Size**: $(du -h cheat-engine-master/release/Cheat Engine.app/Contents/MacOS/cheatengine | cut -f1)" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **Status**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
